import{w as d,d as u}from"./L4rW_yHk.js";import{c as w}from"./Bw6F-9P_.js";import{N as y}from"./Dvm0vAjZ.js";const h=d([]);let c=!1;async function f(){if(c)return y(h);c=!0;try{const{data:t,error:e}=await w.from("ward_mission_goals").select("*").eq("is_active",!0).order("year",{ascending:!1});if(e)throw console.error("[API] Get ward mission goals failed:",e),new Error(`Failed to load goals: ${e.message}`);const r=t||[];return h.set(r),setTimeout(()=>c=!1,800),r}catch(t){throw c=!1,console.error("[API] Unexpected error fetching ward mission goals:",t),t}}async function p(t){try{const{data:e,error:r}=await w.from("ward_mission_goals").insert([t]).select();if(r)throw console.error("[API] Create ward mission goal failed:",r),r.message.includes("JWT")?new Error("Authentication error - please try reloading the page"):r.code==="42501"?new Error("Permission denied - please check your authentication"):r.code==="23505"?new Error("A goal for this year already exists"):r.message.includes("fetch")||r.message.includes("Failed to fetch")?new Error("Network error - please check your connection and try again"):new Error(`Failed to save goal: ${r.message}`);return await f(),console.log("[API] Ward mission goal created successfully"),e?e[0]:void 0}catch(e){throw console.error("[API] Unexpected error creating ward mission goal:",e),e}}async function A(t,e){try{const{data:r,error:s}=await w.from("ward_mission_goals").update(e).eq("id",t).select();if(s)throw console.error("[API] Update ward mission goal failed:",s),s.code==="23505"?new Error("A goal for this year already exists"):s.code==="42501"?new Error("Permission denied - please check your authentication"):new Error(`Failed to update goal: ${s.message}`);return await f(),console.log("[API] Ward mission goal updated successfully"),r?r[0]:void 0}catch(r){throw console.error("[API] Unexpected error updating ward mission goal:",r),r}}async function _(t){try{const{error:e}=await w.from("ward_mission_goals").update({is_active:!1}).eq("id",t);if(e)throw console.error("[API] Delete ward mission goal failed:",e),new Error(`Failed to delete goal: ${e.message}`);await f(),console.log("[API] Ward mission goal deleted successfully")}catch(e){throw console.error("[API] Unexpected error deleting ward mission goal:",e),e}}let n=null;const P=()=>{const t=d(!1),e=d(!1),r=d([]),s=u(r,a=>{const o=new Date().toISOString().split("T")[0];return a.find(g=>g.start_date<=o&&g.end_date>=o)||null}),m=u(r,a=>a.filter(o=>o.is_active).sort((o,i)=>i.year-o.year)),l=async()=>{e.set(!0),t.set(!1);try{const a=await f();a?.length?r.set(a):r.set([]),t.set(!0)}catch(a){console.error("[State] Failed to reload ward mission goals:",a),t.set(!0)}finally{e.set(!1)}};return n={stores:{ready:t,loading:e,data:r,currentGoalPeriod:s,activeGoals:m},actions:{reload:l,apiCreate:async a=>{e.set(!0);try{await p(a),await l()}catch(o){throw console.error("[State] Failed to create ward mission goal:",o),o}finally{e.set(!1)}},apiUpdate:async(a,o)=>{e.set(!0);try{await A(a,o),await l()}catch(i){throw console.error("[State] Failed to update ward mission goal:",i),i}finally{e.set(!1)}},apiDelete:async a=>{e.set(!0);try{await _(a),await l()}catch(o){throw console.error("[State] Failed to delete ward mission goal:",o),o}finally{e.set(!1)}}}},n},G=()=>n?.stores&&Object.keys(n.stores).length>0?n:P();export{G as g};
