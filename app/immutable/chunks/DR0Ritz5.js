import{w as f,g as m,d as u}from"./Bxf54LvK.js";import{a as n}from"./B4JJrO5i.js";const h=f([]);let w=!1;async function l(){if(w)return m(h);w=!0;try{const{data:o,error:e}=await n.from("ward_mission_goals").select("*").order("year",{ascending:!1});if(e)throw console.error("[API] Get ward mission goals failed:",e),new Error(`Failed to load goals: ${e.message}`);const r=o||[];return h.set(r),setTimeout(()=>w=!1,800),r}catch(o){throw w=!1,console.error("[API] Unexpected error fetching ward mission goals:",o),o}}async function p(o){try{const{data:e,error:r}=await n.from("ward_mission_goals").insert([o]).select();if(r)throw console.error("[API] Create ward mission goal failed:",r),r.message.includes("JWT")?new Error("Authentication error - please try reloading the page"):r.code==="42501"?new Error("Permission denied - please check your authentication"):r.code==="23505"?new Error("A goal for this year already exists"):r.message.includes("fetch")||r.message.includes("Failed to fetch")?new Error("Network error - please check your connection and try again"):new Error(`Failed to save goal: ${r.message}`);return await l(),console.log("[API] Ward mission goal created successfully"),e?e[0]:void 0}catch(e){throw console.error("[API] Unexpected error creating ward mission goal:",e),e}}async function P(o,e){try{const{data:r,error:s}=await n.from("ward_mission_goals").update(e).eq("id",o).select();if(s)throw console.error("[API] Update ward mission goal failed:",s),s.code==="23505"?new Error("A goal for this year already exists"):s.code==="42501"?new Error("Permission denied - please check your authentication"):new Error(`Failed to update goal: ${s.message}`);return await l(),console.log("[API] Ward mission goal updated successfully"),r?r[0]:void 0}catch(r){throw console.error("[API] Unexpected error updating ward mission goal:",r),r}}async function A(o){try{const{error:e}=await n.from("ward_mission_goals").update({is_active:!1}).eq("id",o);if(e)throw console.error("[API] Delete ward mission goal failed:",e),new Error(`Failed to delete goal: ${e.message}`);await l(),console.log("[API] Ward mission goal deleted successfully")}catch(e){throw console.error("[API] Unexpected error deleting ward mission goal:",e),e}}async function I(o){try{const{error:e}=await n.from("ward_mission_goals").update({is_active:!0}).eq("id",o);if(e)throw console.error("[API] Restore ward mission goal failed:",e),e.code==="23505"?new Error("Cannot restore - a goal for this year already exists"):e.code==="42501"?new Error("Permission denied - please check your authentication"):new Error(`Failed to restore goal: ${e.message}`);await l(),console.log("[API] Ward mission goal restored successfully")}catch(e){throw console.error("[API] Unexpected error restoring ward mission goal:",e),e}}async function E(o){try{const{error:e}=await n.from("ward_mission_goals").delete().eq("id",o);if(e)throw console.error("[API] Hard delete ward mission goal failed:",e),e.code==="42501"?new Error("Permission denied - please check your authentication"):new Error(`Failed to permanently delete goal: ${e.message}`);await l(),console.log("[API] Ward mission goal permanently deleted successfully")}catch(e){throw console.error("[API] Unexpected error permanently deleting ward mission goal:",e),e}}let d=null;const _=()=>{const o=f(!1),e=f(!1),r=f([]),s=u(r,t=>{const a=new Date().toISOString().split("T")[0];return t.find(g=>g.start_date<=a&&g.end_date>=a)||null}),y=u(r,t=>t.filter(a=>a.is_active).sort((a,c)=>c.year-a.year)),i=async()=>{e.set(!0),o.set(!1);try{const t=await l();t?.length?r.set(t):r.set([]),o.set(!0)}catch(t){console.error("[State] Failed to reload ward mission goals:",t),o.set(!0)}finally{e.set(!1)}};return d={stores:{ready:o,loading:e,data:r,currentGoalPeriod:s,activeGoals:y},actions:{reload:i,apiCreate:async t=>{e.set(!0);try{await p(t),await i()}catch(a){throw console.error("[State] Failed to create ward mission goal:",a),a}finally{e.set(!1)}},apiUpdate:async(t,a)=>{e.set(!0);try{await P(t,a),await i()}catch(c){throw console.error("[State] Failed to update ward mission goal:",c),c}finally{e.set(!1)}},apiDelete:async t=>{e.set(!0);try{await A(t),await i()}catch(a){throw console.error("[State] Failed to delete ward mission goal:",a),a}finally{e.set(!1)}},apiRestore:async t=>{e.set(!0);try{await I(t),await i()}catch(a){throw console.error("[State] Failed to restore ward mission goal:",a),a}finally{e.set(!1)}},apiHardDelete:async t=>{e.set(!0);try{await E(t),await i()}catch(a){throw console.error("[State] Failed to permanently delete ward mission goal:",a),a}finally{e.set(!1)}}}},d},v=()=>d?.stores&&Object.keys(d.stores).length>0?d:_();export{v as g};
