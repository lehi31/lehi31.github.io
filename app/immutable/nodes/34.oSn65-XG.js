import"../chunks/NZTpNUN0.js";import"../chunks/69_IOA4Y.js";import{P as at}from"../chunks/CXJ8rOIO.js";import{w as We,g as Qe,c as et,o as rt}from"../chunks/DHXte27T.js";import{p as He,ai as N,D as l,E as y,g as e,aj as Ue,c as o,s as f,r as i,u as M,t as Q,a as Ve,f as X,F as tt,R as it}from"../chunks/CPOcesE7.js";import{b as oe,i as D,e as K,a as Ye,s as me}from"../chunks/opPvMm1W.js";import{e as xe,i as $e}from"../chunks/DAwrR-3T.js";import{f as _,a as d,c as Me,t as De}from"../chunks/YsHTGu5k.js";import{r as Ee,s as we}from"../chunks/CwdjhnPO.js";import{i as Ge}from"../chunks/C2Q_9cr2.js";import{D as Xe}from"../chunks/Dfq0d5vk.js";import{S as Le}from"../chunks/D_S-OItw.js";import{b as ue,g as nt,P as ot}from"../chunks/Cr6r6oBq.js";import{g as Je}from"../chunks/C03Kye7r.js";import{b as ke}from"../chunks/QDlYjqxz.js";import{p as st}from"../chunks/CdEA5IGF.js";const lt=`
	*,
	member_list_members (
		id,
		list_id,
		member_id,
		added_by,
		created_at,
		members (
			id,
			first_name,
			last_name,
			date_of_birth,
			phone_number
		)
	)
`;async function dt(){const{data:g,error:v}=await ue.from("member_lists").select(lt).order("name");if(v)throw v;return g||[]}async function ct(g){const{data:v,error:b}=await ue.from("member_lists").insert({name:g}).select().single();if(b)throw b;return v}async function mt(g,v){const{data:b,error:w}=await ue.from("member_lists").update({name:v,updated_at:new Date().toISOString()}).eq("id",g).select().single();if(w)throw w;return b}async function ut(g){const{error:v}=await ue.from("member_lists").delete().eq("id",g);if(v)throw v}async function Ze(g,v){const{data:b,error:w}=await ue.from("member_list_members").insert({list_id:g,member_id:v}).select("id, list_id, member_id, added_by, created_at").single();if(w)throw w;return b}async function ft(g,v){const{error:b}=await ue.from("member_list_members").delete().eq("list_id",g).eq("member_id",v);if(b)throw b}let je=null;const vt=()=>{const g=We(!1),v=We([]),b=We(null),w=async()=>{g.set(!1);const n=await dt();v.set(n);const L=Qe(b);!L&&n.length?b.set(n[0].id??null):L&&(n.some(F=>F.id===L)||b.set(n.length?n[0].id??null:null)),g.set(!0)};return je={stores:{ready:g,lists:v,selectedListId:b},actions:{reload:w,selectList:n=>{b.set(n)},createListWithMembers:async(n,L)=>{const R=await ct(n);if(R.id)for(const F of L)await Ze(R.id,F);return await w(),Qe(v).find(F=>F.id===R.id)??null},renameList:async(n,L)=>{await mt(n,L),await w()},removeList:async n=>{await ut(n),await w()},addMember:async(n,L)=>{await Ze(n,L),await w()},removeMember:async(n,L)=>{await ft(n,L),await w()}}},je},Ke=()=>je||vt();var bt=_('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-primary" type="button">Add</button></li>'),pt=_('<ul class="list-group list-group-flush border rounded mt-2"></ul>'),_t=_('<p class="text-muted mt-2">No members match that search.</p>'),gt=_('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-link text-danger text-decoration-none" type="button">Remove</button></li>'),ht=_('<div class="mt-3"><p class="mb-2">Selected members:</p> <ul class="list-group list-group-flush border rounded"></ul></div>'),yt=_("<!> Creating...",1),wt=_('<form class="d-flex flex-column gap-3"><div><label class="form-label" for="member-list-name">List name</label> <input id="member-list-name" class="form-control" type="text" required placeholder="e.g., Temple Preparation"/></div> <div><label class="form-label" for="member-list-members">Members (optional)</label> <input id="member-list-members" class="form-control" type="text" placeholder="Search members..."/> <!> <!></div> <div class="d-flex justify-content-end gap-2"><button class="btn btn-secondary" type="button" data-bs-dismiss="offcanvas">Cancel</button> <button class="btn btn-primary" type="submit"><!></button></div></form>');function Lt(g,v){He(v,!1);const b=()=>oe(R,"$members",w),[w,Z]=Ye(),A=y(),U=y();let S=y(!1),E=y(""),a=y([]),n=y("");const L=et(),{stores:{members:R}}=Je(),{actions:{createListWithMembers:F}}=Ke();function fe(s,c=[],t=6){if(!s.trim())return[];const p=s.toLowerCase();return e(A).filter(m=>{if(!m.id||c.includes(m.id))return!1;const x=m.first_name?.toLowerCase()??"",$=m.last_name?.toLowerCase()??"";return`${x} ${$}`.includes(p)}).slice(0,t)}function ve(s){!s.id||e(a).some(t=>t.id===s.id)||(l(a,[...e(a),s]),l(n,""))}function be(s){l(a,e(a).filter(c=>c.id!==s))}async function pe(s){if(s.preventDefault(),!e(E).trim())return;l(S,!0);const c=e(a).map(t=>t.id||0).filter(t=>!!t);try{await F(e(E).trim(),c),l(E,""),l(a,[]),l(n,""),L("listCreated")}catch(t){console.error("Failed to create list",t)}finally{l(S,!1)}}N(()=>b(),()=>{l(A,b()||[])}),N(()=>(e(n),e(a)),()=>{l(U,fe(e(n),e(a).map(s=>s.id||0).filter(s=>!!s)))}),Ue(),Ge();var Y=wt(),G=o(Y),J=f(o(G),2);Ee(J),i(G);var C=f(G,2),I=f(o(C),2);Ee(I);var q=f(I,2);{var O=s=>{var c=pt();xe(c,5,()=>e(U),$e,(t,p)=>{var m=bt(),x=o(m),$=o(x);i(x);var W=f(x,2);i(m),Q(()=>me($,`${e(p),M(()=>e(p).first_name)??""} ${e(p),M(()=>e(p).last_name)??""}`)),K("click",W,()=>ve(e(p))),d(t,m)}),i(c),d(s,c)},ee=s=>{var c=Me(),t=X(c);{var p=m=>{var x=_t();d(m,x)};D(t,m=>{e(n),M(()=>e(n).trim())&&m(p)},!0)}d(s,c)};D(q,s=>{e(U),M(()=>e(U).length)?s(O):s(ee,!1)})}var _e=f(q,2);{var ge=s=>{var c=ht(),t=f(o(c),2);xe(t,5,()=>e(a),$e,(p,m)=>{var x=gt(),$=o(x),W=o($);i($);var T=f($,2);i(x),Q(()=>me(W,`${e(m),M(()=>e(m).first_name)??""} ${e(m),M(()=>e(m).last_name)??""}`)),K("click",T,()=>{e(m)?.id&&be(e(m)?.id)}),d(p,x)}),i(t),i(c),d(s,c)};D(_e,s=>{e(a),M(()=>e(a).length)&&s(ge)})}i(C);var te=f(C,2),se=f(o(te),2),he=o(se);{var le=s=>{var c=yt(),t=X(c);Le(t,{size:"sm"}),tt(),d(s,c)},h=s=>{var c=De("Create List");d(s,c)};D(he,s=>{e(S)?s(le):s(h,!1)})}i(se),i(te),i(Y),Q(()=>se.disabled=e(S)),ke(J,()=>e(E),s=>l(E,s)),ke(I,()=>e(n),s=>l(n,s)),K("submit",Y,st(pe)),d(g,Y),Ve(),Z()}var xt=_("<!> Deleting...",1),$t=_('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-primary" type="button">Add</button></li>'),Mt=_('<ul class="list-group list-group-flush border rounded mt-2"></ul>'),St=_('<p class="text-muted mt-2">No members match that search.</p>'),Ct=_('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-link text-danger text-decoration-none" type="button" aria-label="Remove member"><i class="bi bi-trash"></i></button></li>'),It=_('<ul class="list-group"></ul>'),Dt=_('<p class="text-muted">No members in this list yet.</p>'),Et=_('<div class="d-flex flex-column gap-4"><div class="d-flex flex-column gap-4"><form class="d-flex flex-column gap-2"><input class="form-control" type="text" placeholder="List name"/> <div class="d-flex justify-content-between gap-2"><button class="btn btn-danger" aria-label="Delete list" type="button"><!></button> <div class="d-flex gap-2"><button class="btn btn-secondary" aria-label="Cancel" type="button" data-bs-dismiss="offcanvas"><!></button> <button class="btn btn-primary" aria-label="save" type="submit"><!></button></div></div></form></div> <div><h2 class="h6 mb-2">Add Member</h2> <input class="form-control" type="text" placeholder="Search members..."/> <!></div> <div><div class="d-flex align-items-center justify-content-between gap-2 mb-2"><h2 class="h6 mb-0">Members</h2></div> <!></div></div>'),kt=_('<p class="text-muted">Select a list to manage it.</p>');function jt(g,v){He(v,!1);const b=()=>oe(fe,"$lists",A),w=()=>oe(ve,"$selectedListId",A),Z=()=>oe(F,"$members",A),[A,U]=Ye(),S=y(),E=y(),a=y(),n=y(),L=y(),R=y(),{stores:{members:F}}=Je(),{stores:{lists:fe,selectedListId:ve},actions:{addMember:be,removeMember:pe,renameList:Y,removeList:G}}=Ke(),J=et();let C=y(""),I=y(""),q=y(!1),O=y(!1),ee=y(null);function _e(t,p=[],m=6){if(!t.trim())return[];const x=t.toLowerCase();return e(L).filter($=>{if(!$.id||p.includes($.id))return!1;const W=$.first_name?.toLowerCase()??"",T=$.last_name?.toLowerCase()??"";return`${W} ${T}`.includes(x)}).slice(0,m)}async function ge(t){e(a)&&(await be(e(a).id,t),l(C,""))}async function te(t){e(a)&&await pe(e(a).id,t)}async function se(t){if(t.preventDefault(),!(!e(a)||!e(I).trim())){l(q,!0);try{await Y(e(a).id,e(I).trim())}catch(p){console.error("Failed to rename list",p)}finally{l(q,!1),J("listRenamed")}}}async function he(){if(e(a)&&confirm("Are you sure you want to delete this member list?")){l(O,!0);try{await G(e(a).id)}catch(t){console.error("Failed to delete list",t)}finally{l(O,!1),J("listDeleted")}}}N(()=>b(),()=>{l(S,b()||[])}),N(()=>w(),()=>{l(E,w())}),N(()=>(e(S),e(E)),()=>{l(a,e(S).find(t=>t.id===e(E))||null)}),N(()=>e(a),()=>{l(R,e(a)?.member_list_members?.map(t=>t.member_id)??[])}),N(()=>(e(a),e(C),e(R)),()=>{l(n,e(a)?_e(e(C),e(R)):[])}),N(()=>Z(),()=>{l(L,Z()||[])}),N(()=>(e(a),e(ee)),()=>{(e(a)?.id??null)!==e(ee)&&(l(ee,e(a)?.id??null),l(I,e(a)?.name??""))}),Ue(),Ge();var le=Me(),h=X(le);{var s=t=>{var p=Et(),m=o(p),x=o(m),$=o(x);Ee($);var W=f($,2),T=o(W),Ne=o(T);{var Se=r=>{var u=xt(),z=X(u);Le(z,{size:"sm"}),tt(),d(r,u)},Pe=r=>{var u=De("Delete List");d(r,u)};D(Ne,r=>{e(O)?r(Se):r(Pe,!1)})}i(T);var P=f(T,2),k=o(P),de=o(k);{var Re=r=>{Le(r,{size:"sm"})},ze=r=>{var u=De("Cancel");d(r,u)};D(de,r=>{e(q)?r(Re):r(ze,!1)})}i(k);var H=f(k,2),ae=o(H);{var Ae=r=>{Le(r,{size:"sm"})},re=r=>{var u=De("Save");d(r,u)};D(ae,r=>{e(q)?r(Ae):r(re,!1)})}i(H),i(P),i(W),i(x),i(m);var ie=f(m,2),ne=f(o(ie),2);Ee(ne);var Fe=f(ne,2);{var Ce=r=>{var u=Mt();xe(u,5,()=>e(n),$e,(z,j)=>{var B=$t(),V=o(B),Be=o(V);i(V);var Oe=f(V,2);i(B),Q(()=>me(Be,`${e(j),M(()=>e(j).first_name)??""} ${e(j),M(()=>e(j).last_name)??""}`)),K("click",Oe,()=>{e(j)?.id&&ge(e(j)?.id)}),d(z,B)}),i(u),d(r,u)},ye=r=>{var u=Me(),z=X(u);{var j=B=>{var V=St();d(B,V)};D(z,B=>{e(C),M(()=>e(C).trim())&&B(j)},!0)}d(r,u)};D(Fe,r=>{e(n),M(()=>e(n).length)?r(Ce):r(ye,!1)})}i(ie);var Ie=f(ie,2),ce=f(o(Ie),2);{var qe=r=>{var u=It();xe(u,5,()=>(e(a),M(()=>e(a).member_list_members)),$e,(z,j)=>{var B=Ct(),V=o(B),Be=o(V);i(V);var Oe=f(V,2);i(B),Q(()=>me(Be,`${e(j),M(()=>e(j).members?.first_name)??""} ${e(j),M(()=>e(j).members?.last_name)??""}`)),K("click",Oe,()=>te(e(j).member_id)),d(z,B)}),i(u),d(r,u)},Te=r=>{var u=Dt();d(r,u)};D(ce,r=>{e(a),M(()=>e(a).member_list_members?.length)?r(qe):r(Te,!1)})}i(Ie),i(p),Q(()=>{T.disabled=e(O),k.disabled=e(q),H.disabled=e(q)}),ke($,()=>e(I),r=>l(I,r)),K("click",T,he),K("submit",x,st(se)),ke(ne,()=>e(C),r=>l(C,r)),d(t,p)},c=t=>{var p=kt();d(t,p)};D(h,t=>{e(a)?t(s):t(c,!1)})}d(g,le),Ve(),U()}var Nt=_('<div class="alert alert-warning mt-4">You do not have permission to manage member lists.</div>'),Pt=_('<a class="btn btn-sm btn-primary d-flex align-items-center gap-1" target="_blank" rel="noopener noreferrer" aria-label="Send text message to members"><i class="bi bi-chat-dots"></i></a>'),Rt=_('<button class="btn btn-sm btn-outline-primary" type="button" disabled title="Add members with phone numbers to enable texting"><i class="bi bi-chat-dots"></i></button>'),zt=_('<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><div> </div> <div class="d-flex align-items-center gap-2" aria-label="List actions" role="group"><span class="badge bg-secondary rounded-pill"> </span> <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="offcanvas" aria-label="Edit list"><i class="bi bi-pencil"></i></button> <!></div></div>'),At=_('<div class="list-group list-group-flush"></div>'),Ft=_('<p class="text-muted p-3 mb-0">No lists yet. Create one to get started.</p>'),qt=_('<div class="p-4"><!></div>'),Tt=_('<div class="card"><div class="card-header"><div class="d-flex justify-content-between align-items-center w-100"><span>Lists</span> <div class="d-flex align-items-center gap-2"><button class="btn btn-primary btn-sm" aria-label="Create new list" type="button" data-bs-toggle="offcanvas"><i class="bi bi-plus"></i></button></div></div></div> <div class="card-body p-0"><!></div></div> <!> <!>',1);function Bt(g,v){He(v,!1);const b=()=>oe(ve,"$lists",A),w=()=>oe(be,"$selectedListId",A),Z=()=>oe(fe,"$ready",A),[A,U]=Ye(),S=y(),E=y(),a=y(),n=y(),L=y(),{stores:{currentUserHasPermission:R}}=nt(),{actions:{reload:F}}=Je(),{stores:{ready:fe,lists:ve,selectedListId:be},actions:{reload:pe,selectList:Y}}=Ke();let G=y(!1),J=!1;rt(()=>{const h=R.subscribe(s=>{const c=s(ot.ManageMemberLists);c&&!J&&(J=!0,F().catch(t=>console.error("Members reload failed",t)),pe().catch(t=>console.error("Member lists reload failed",t))),l(G,c)});return()=>{h()}});const C="member-lists-create-drawer",I="member-lists-edit-drawer";function q(h){return h?h.replace(/[^\d+]/g,""):""}function O(h){if(typeof window>"u")return;const s=document.getElementById(h);if(!s)return;window.bootstrap?.Offcanvas?.getInstance(s)?.hide()}function ee(){O(I)}function _e(){O(I)}function ge(){O(C)}N(()=>b(),()=>{l(S,b()||[])}),N(()=>w(),()=>{l(E,w())}),N(()=>(e(S),e(E)),()=>{l(a,e(S).find(h=>h.id===e(E))||null)}),N(()=>e(a),()=>{l(n,e(a)?.member_list_members?.map(h=>q(h.members?.phone_number)).filter(h=>h.length>0)??[])}),N(()=>e(n),()=>{l(L,e(n).length?`sms:${e(n).join(";")}`:"")}),Ue(),Ge();var te=Me(),se=X(te);{var he=h=>{var s=Nt();d(h,s)},le=h=>{var s=Tt(),c=X(s),t=o(c),p=o(t),m=f(o(p),2),x=o(m);we(x,"data-bs-target",`#${C}`),we(x,"aria-controls",C),i(m),i(p),i(t);var $=f(t,2),W=o($);{var T=P=>{var k=Me(),de=X(k);{var Re=H=>{var ae=At();xe(ae,5,()=>e(S),$e,(Ae,re)=>{var ie=zt(),ne=o(ie),Fe=o(ne,!0);i(ne);var Ce=f(ne,2),ye=o(Ce),Ie=o(ye,!0);i(ye);var ce=f(ye,2);we(ce,"data-bs-target",`#${I}`),we(ce,"aria-controls",I);var qe=f(ce,2);{var Te=u=>{var z=Pt();Q(()=>we(z,"href",e(L))),d(u,z)},r=u=>{var z=Rt();d(u,z)};D(qe,u=>{e(L)?u(Te):u(r,!1)})}i(Ce),i(ie),Q(()=>{me(Fe,(e(re),M(()=>e(re).name))),me(Ie,(e(re),M(()=>e(re).member_list_members?.length??0)))}),K("click",ce,()=>Y(e(re).id??null)),d(Ae,ie)}),i(ae),d(H,ae)},ze=H=>{var ae=Ft();d(H,ae)};D(de,H=>{e(S),M(()=>e(S).length)?H(Re):H(ze,!1)})}d(P,k)},Ne=P=>{var k=qt(),de=o(k);Le(de,{}),i(k),d(P,k)};D(W,P=>{Z()?P(T):P(Ne,!1)})}i($),i(c);var Se=f(c,2);Xe(Se,{title:"Create Member List",id:C,children:(P,k)=>{Lt(P,{$$events:{listCreated:ge}})},$$slots:{default:!0}});var Pe=f(Se,2);{let P=it(()=>(e(a),M(()=>e(a)?`Edit ${e(a).name}`:"Edit Member List")));Xe(Pe,{get title(){return e(P)},id:I,children:(k,de)=>{jt(k,{$$events:{listDeleted:ee,listRenamed:_e}})},$$slots:{default:!0}})}d(h,s)};D(se,h=>{e(G)?h(le,!1):h(he)})}d(g,te),Ve(),U()}function rs(g){at(g,{pageTitle:"Member Lists",children:(v,b)=>{Bt(v,{})},$$slots:{default:!0}})}export{rs as component};
