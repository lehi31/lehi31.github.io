import"../chunks/NZTpNUN0.js";import"../chunks/69_IOA4Y.js";import{w as We,g as et,o as Nt}from"../chunks/DjNGvcU6.js";import{p as qt,aj as Y,ak as zt,a as Rt,g as e,f as G,D as o,E as p,c as r,s as l,r as s,u,t as te,F as tt,R as Tt}from"../chunks/JKZwkikK.js";import{a as Ft,b as we,i as M,e as J,s as oe}from"../chunks/BxjzTaz1.js";import{e as ue,i as fe}from"../chunks/B2BlSr7K.js";import{c as be,a as i,f as c,t as xe}from"../chunks/JDsN5plM.js";import{s as Le,r as Me}from"../chunks/D9e7wtdi.js";import{b as le,g as Bt,P as Wt,c as Ht}from"../chunks/C2SkVY-I.js";import{b as Se}from"../chunks/BL6gm64P.js";import{p as at}from"../chunks/CdEA5IGF.js";import{i as Ot}from"../chunks/b8c_lO2i.js";import{P as Ut}from"../chunks/D3Xc9rmC.js";import{D as st}from"../chunks/B5lPJz8b.js";import{S as _e}from"../chunks/D7kKG8TJ.js";import{g as Vt}from"../chunks/BR9Lt1um.js";const Yt=`
	*,
	member_list_members (
		id,
		list_id,
		member_id,
		added_by,
		created_at,
		members (
			id,
			first_name,
			last_name,
			date_of_birth,
			phone_number
		)
	)
`;async function Gt(){const{data:_,error:f}=await le.from("member_lists").select(Yt).order("name");if(f)throw f;return _||[]}async function Jt(_){const{data:f,error:b}=await le.from("member_lists").insert({name:_}).select().single();if(b)throw b;return f}async function Kt(_,f){const{data:b,error:y}=await le.from("member_lists").update({name:f,updated_at:new Date().toISOString()}).eq("id",_).select().single();if(y)throw y;return b}async function Qt(_){const{error:f}=await le.from("member_lists").delete().eq("id",_);if(f)throw f}async function rt(_,f){const{data:b,error:y}=await le.from("member_list_members").insert({list_id:_,member_id:f}).select("id, list_id, member_id, added_by, created_at").single();if(y)throw y;return b}async function Xt(_,f){const{error:b}=await le.from("member_list_members").delete().eq("list_id",_).eq("member_id",f);if(b)throw b}let $e=null;const Zt=()=>{const _=We(!1),f=We([]),b=We(null),y=async()=>{_.set(!1);const t=await Gt();f.set(t);const x=et(b);!x&&t.length?b.set(t[0].id??null):x&&(t.some(T=>T.id===x)||b.set(t.length?t[0].id??null:null)),_.set(!0)};return $e={stores:{ready:_,lists:f,selectedListId:b},actions:{reload:y,selectList:t=>{b.set(t)},createListWithMembers:async(t,x)=>{const R=await Jt(t);if(R.id)for(const T of x)await rt(R.id,T);return await y(),et(f).find(T=>T.id===R.id)??null},renameList:async(t,x)=>{await Kt(t,x),await y()},removeList:async t=>{await Qt(t),await y()},addMember:async(t,x)=>{await rt(t,x),await y()},removeMember:async(t,x)=>{await Xt(t,x),await y()}}},$e},ea=()=>$e||Zt();var ta=c('<div class="alert alert-warning mt-4">You do not have permission to manage member lists.</div>'),aa=c('<button type="button" data-bs-toggle="offcanvas"><span> </span> <span class="badge bg-secondary rounded-pill"> </span></button>'),sa=c('<div class="list-group list-group-flush"></div>'),ra=c('<p class="text-muted p-3 mb-0">No lists yet. Create one to get started.</p>'),ia=c('<div class="p-4"><!></div>'),na=c('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-primary" type="button">Add</button></li>'),oa=c('<ul class="list-group list-group-flush border rounded mt-2"></ul>'),la=c('<p class="text-muted mt-2">No members match that search.</p>'),da=c('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-link text-danger text-decoration-none" type="button">Remove</button></li>'),ca=c('<div class="mt-3"><p class="mb-2">Selected members:</p> <ul class="list-group list-group-flush border rounded"></ul></div>'),ma=c("<!> Creating...",1),va=c('<form class="d-flex flex-column gap-3"><div><label class="form-label" for="member-list-name">List name</label> <input id="member-list-name" class="form-control" type="text" required placeholder="e.g., Temple Preparation"/></div> <div><label class="form-label" for="member-list-members">Members (optional)</label> <input id="member-list-members" class="form-control" type="text" placeholder="Search members..."/> <!> <!></div> <div class="d-flex justify-content-end gap-2"><button class="btn btn-secondary" type="button" data-bs-dismiss="offcanvas">Cancel</button> <button class="btn btn-primary" type="submit"><!></button></div></form>'),ua=c("<!> Deleting...",1),fa=c('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-primary" type="button">Add</button></li>'),ba=c('<ul class="list-group list-group-flush border rounded mt-2"></ul>'),_a=c('<p class="text-muted mt-2">No members match that search.</p>'),pa=c('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-link text-danger text-decoration-none" type="button" aria-label="Remove member"><i class="bi bi-trash"></i></button></li>'),ga=c('<ul class="list-group"></ul>'),ya=c('<p class="text-muted">No members in this list yet.</p>'),ha=c('<div class="d-flex flex-column gap-4"><div class="d-flex flex-column gap-4"><form class="d-flex gap-2"><input class="form-control" type="text" placeholder="List name"/></form> <div class="d-flex justify-content-between gap-2"><button class="btn btn-danger" aria-label="Delete list" type="button"><!></button> <div class="d-flex gap-2"><button class="btn btn-secondary" aria-label="Cancel" type="button" data-bs-dismiss="offcanvas"><!></button> <button class="btn btn-primary" aria-label="save" type="submit"><!></button></div></div></div> <div><h2 class="h6 mb-2">Add Member</h2> <input class="form-control" type="text" placeholder="Search members..."/> <!></div> <div><h2 class="h6">Members</h2> <!></div></div>'),wa=c('<p class="text-muted">Select a list to manage it.</p>'),xa=c('<div class="card"><div class="card-header"><div class="d-flex justify-content-between align-items-center w-100"><span>Lists</span> <div class="d-flex align-items-center gap-2"><button class="btn btn-primary btn-sm" aria-label="Create new list" type="button" data-bs-toggle="offcanvas"><i class="bi bi-plus"></i></button></div></div></div> <div class="card-body p-0"><!></div></div> <!> <!>',1);function Ta(_,f){qt(f,!1);const b=()=>we(dt,"$lists",de),y=()=>we(ct,"$selectedListId",de),De=()=>we(nt,"$members",de),He=()=>we(lt,"$ready",de),[de,Oe]=Ft(),K=p(),ae=p(),t=p(),x=p(),R=p(),T=p(),pe=p(),{stores:{currentUserHasPermission:it}}=Bt(),{stores:{members:nt},actions:{reload:ot}}=Vt(),{stores:{ready:lt,lists:dt,selectedListId:ct},actions:{reload:mt,selectList:vt,createListWithMembers:ut,addMember:ft,removeMember:bt,renameList:_t,removeList:pt}}=ea();let Ue=p(!1),Ve=!1;Nt(()=>{const n=it.subscribe(C=>{const h=C(Wt.ManageMemberLists);h&&!Ve&&(Ve=!0,ot().catch(X=>console.error("Members reload failed",X)),mt().catch(X=>console.error("Member lists reload failed",X))),o(Ue,h)});return()=>{n()}});let ce=p(""),D=p([]),H=p(""),Q=p(""),me=p(""),Ie=p(null),ge=p(!1),se=p(!1),ye=p(!1);const Ce="member-lists-create-drawer",ke="member-lists-edit-drawer";function Ye(n,C=[],h=6){if(!n.trim())return[];const X=n.toLowerCase();return e(x).filter(re=>{if(!re.id||C.includes(re.id))return!1;const je=re.first_name?.toLowerCase()??"",O=re.last_name?.toLowerCase()??"";return`${je} ${O}`.includes(X)}).slice(0,h)}function gt(n){!n.id||e(D).some(h=>h.id===n.id)||(o(D,[...e(D),n]),o(H,""))}function yt(n){o(D,e(D).filter(C=>C.id!==n))}async function ht(n){if(n.preventDefault(),!e(ce).trim())return;o(ge,!0);const C=e(D).map(h=>h.id||0).filter(h=>!!h);try{await ut(e(ce).trim(),C),o(ce,""),o(D,[]),o(H,"")}catch(h){console.error("Failed to create list",h)}finally{o(ge,!1)}}async function wt(n){e(t)&&(await ft(e(t).id,n),o(Q,""))}async function xt(n){e(t)&&await bt(e(t).id,n)}async function Lt(n){if(n.preventDefault(),!(!e(t)||!e(me).trim())){o(se,!0);try{await _t(e(t).id,e(me).trim())}catch(C){console.error("Failed to rename list",C)}finally{o(se,!1)}}}async function Mt(){if(e(t)&&confirm("Are you sure you want to delete this member list?")){o(ye,!0);try{await pt(e(t).id)}catch(n){console.error("Failed to delete list",n)}finally{o(ye,!1)}}}Y(()=>b(),()=>{o(K,b()||[])}),Y(()=>y(),()=>{o(ae,y())}),Y(()=>(e(K),e(ae)),()=>{o(t,e(K).find(n=>n.id===e(ae))||null)}),Y(()=>(e(t),e(Ie)),()=>{(e(t)?.id??null)!==e(Ie)&&(o(Ie,e(t)?.id??null),o(me,e(t)?.name??""))}),Y(()=>De(),()=>{o(x,De()||[])}),Y(()=>(e(H),e(D)),()=>{o(R,Ye(e(H),e(D).map(n=>n.id||0).filter(n=>!!n)))}),Y(()=>e(t),()=>{o(T,e(t)?.member_list_members?.map(n=>n.member_id)??[])}),Y(()=>(e(t),e(Q),e(T)),()=>{o(pe,e(t)?Ye(e(Q),e(T)):[])}),zt(),Ot(),Ut(_,{pageTitle:"Member Lists",children:(n,C)=>{var h=be(),X=G(h);{var re=O=>{var he=ta();i(O,he)},je=O=>{var he=xa(),Ee=G(he),Pe=r(Ee),Ge=r(Pe),Je=l(r(Ge),2),Ke=r(Je);Le(Ke,"data-bs-target",`#${Ce}`),Le(Ke,"aria-controls",Ce),s(Je),s(Ge),s(Pe);var Qe=l(Pe,2),St=r(Qe);{var $t=N=>{var F=be(),B=G(F);{var U=I=>{var k=sa();ue(k,5,()=>e(K),fe,(j,w)=>{var S=aa();Le(S,"data-bs-target",`#${ke}`),Le(S,"aria-controls",ke);var q=r(S),ne=r(q,!0);s(q);var V=l(q,2),E=r(V,!0);s(V),s(S),te(()=>{Ht(S,1,(e(w),e(ae),u(()=>`list-group-item list-group-item-action d-flex justify-content-between align-items-center ${e(w).id===e(ae)?"active":""}`))),oe(ne,(e(w),u(()=>e(w).name))),oe(E,(e(w),u(()=>e(w).member_list_members?.length??0)))}),J("click",S,()=>vt(e(w).id??null)),i(j,S)}),s(k),i(I,k)},ie=I=>{var k=ra();i(I,k)};M(B,I=>{e(K),u(()=>e(K).length)?I(U):I(ie,!1)})}i(N,F)},Dt=N=>{var F=ia(),B=r(F);_e(B,{}),s(F),i(N,F)};M(St,N=>{He()?N($t):N(Dt,!1)})}s(Qe),s(Ee);var Xe=l(Ee,2);st(Xe,{title:"Create Member List",id:Ce,children:(N,F)=>{var B=va(),U=r(B),ie=l(r(U),2);Me(ie),s(U);var I=l(U,2),k=l(r(I),2);Me(k);var j=l(k,2);{var w=d=>{var v=oa();ue(v,5,()=>e(R),fe,(z,P)=>{var g=na(),$=r(g),Z=r($);s($);var ve=l($,2);s(g),te(()=>oe(Z,`${e(P),u(()=>e(P).first_name)??""} ${e(P),u(()=>e(P).last_name)??""}`)),J("click",ve,()=>gt(e(P))),i(z,g)}),s(v),i(d,v)},S=d=>{var v=be(),z=G(v);{var P=g=>{var $=la();i(g,$)};M(z,g=>{e(H),u(()=>e(H).trim())&&g(P)},!0)}i(d,v)};M(j,d=>{e(R),u(()=>e(R).length)?d(w):d(S,!1)})}var q=l(j,2);{var ne=d=>{var v=ca(),z=l(r(v),2);ue(z,5,()=>e(D),fe,(P,g)=>{var $=da(),Z=r($),ve=r(Z);s(Z);var ze=l(Z,2);s($),te(()=>oe(ve,`${e(g),u(()=>e(g).first_name)??""} ${e(g),u(()=>e(g).last_name)??""}`)),J("click",ze,()=>{e(g)?.id&&yt(e(g)?.id)}),i(P,$)}),s(z),s(v),i(d,v)};M(q,d=>{e(D),u(()=>e(D).length)&&d(ne)})}s(I);var V=l(I,2),E=l(r(V),2),Ae=r(E);{var Ne=d=>{var v=ma(),z=G(v);_e(z,{size:"sm"}),tt(),i(d,v)},qe=d=>{var v=xe("Create List");i(d,v)};M(Ae,d=>{e(ge)?d(Ne):d(qe,!1)})}s(E),s(V),s(B),te(()=>E.disabled=e(ge)),Se(ie,()=>e(ce),d=>o(ce,d)),Se(k,()=>e(H),d=>o(H,d)),J("submit",B,at(ht)),i(N,B)},$$slots:{default:!0}});var It=l(Xe,2);{let N=Tt(()=>(e(t),u(()=>e(t)?`Edit ${e(t).name}`:"Edit Member List")));st(It,{get title(){return e(N)},id:ke,children:(F,B)=>{var U=be(),ie=G(U);{var I=j=>{var w=ha(),S=r(w),q=r(S),ne=r(q);Me(ne),s(q);var V=l(q,2),E=r(V),Ae=r(E);{var Ne=a=>{var m=ua(),ee=G(m);_e(ee,{size:"sm"}),tt(),i(a,m)},qe=a=>{var m=xe("Delete List");i(a,m)};M(Ae,a=>{e(ye)?a(Ne):a(qe,!1)})}s(E);var d=l(E,2),v=r(d),z=r(v);{var P=a=>{_e(a,{size:"sm"})},g=a=>{var m=xe("Cancel");i(a,m)};M(z,a=>{e(se)?a(P):a(g,!1)})}s(v);var $=l(v,2),Z=r($);{var ve=a=>{_e(a,{size:"sm"})},ze=a=>{var m=xe("Save");i(a,m)};M(Z,a=>{e(se)?a(ve):a(ze,!1)})}s($),s(d),s(V),s(S);var Re=l(S,2),Te=l(r(Re),2);Me(Te);var Ct=l(Te,2);{var kt=a=>{var m=ba();ue(m,5,()=>e(pe),fe,(ee,L)=>{var A=fa(),W=r(A),Fe=r(W);s(W);var Be=l(W,2);s(A),te(()=>oe(Fe,`${e(L),u(()=>e(L).first_name)??""} ${e(L),u(()=>e(L).last_name)??""}`)),J("click",Be,()=>{e(L)?.id&&wt(e(L)?.id)}),i(ee,A)}),s(m),i(a,m)},jt=a=>{var m=be(),ee=G(m);{var L=A=>{var W=_a();i(A,W)};M(ee,A=>{e(Q),u(()=>e(Q).trim())&&A(L)},!0)}i(a,m)};M(Ct,a=>{e(pe),u(()=>e(pe).length)?a(kt):a(jt,!1)})}s(Re);var Ze=l(Re,2),Et=l(r(Ze),2);{var Pt=a=>{var m=ga();ue(m,5,()=>(e(t),u(()=>e(t).member_list_members)),fe,(ee,L)=>{var A=pa(),W=r(A),Fe=r(W);s(W);var Be=l(W,2);s(A),te(()=>oe(Fe,`${e(L),u(()=>e(L).members?.first_name)??""} ${e(L),u(()=>e(L).members?.last_name)??""}`)),J("click",Be,()=>xt(e(L).member_id)),i(ee,A)}),s(m),i(a,m)},At=a=>{var m=ya();i(a,m)};M(Et,a=>{e(t),u(()=>e(t).member_list_members?.length)?a(Pt):a(At,!1)})}s(Ze),s(w),te(()=>{E.disabled=e(ye),v.disabled=e(se),$.disabled=e(se)}),Se(ne,()=>e(me),a=>o(me,a)),J("submit",q,at(Lt)),J("click",E,Mt),Se(Te,()=>e(Q),a=>o(Q,a)),i(j,w)},k=j=>{var w=wa();i(j,w)};M(ie,j=>{e(t)?j(I):j(k,!1)})}i(F,U)},$$slots:{default:!0}})}i(O,he)};M(X,O=>{e(Ue)?O(je,!1):O(re)})}i(n,h)},$$slots:{default:!0}}),Rt(),Oe()}export{Ta as component};
