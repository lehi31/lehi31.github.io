import"../chunks/NZTpNUN0.js";import"../chunks/69_IOA4Y.js";import{P as at}from"../chunks/CCz_dVc3.js";import{w as We,g as Qe,c as et,o as rt}from"../chunks/B8gJkoMb.js";import{p as Ue,ay as P,a8 as l,U as y,g as e,az as He,c as o,s as f,r as i,u as M,t as Q,a as Ve,f as X,aa as tt,I as it}from"../chunks/D6GkHfO-.js";import{i as D,e as K,s as me}from"../chunks/DYmw-k_K.js";import{e as xe,i as $e}from"../chunks/COMoFu8N.js";import{f as _,a as d,c as Me,t as De}from"../chunks/D8wZRsgK.js";import{r as Ee,s as we}from"../chunks/DsJSLd4M.js";import{i as Ye}from"../chunks/XlJfi8GN.js";import{a as oe,s as Ge}from"../chunks/C8uFvBRH.js";import{D as Xe}from"../chunks/DH5YToVs.js";import{S as Le}from"../chunks/BuBHfUc8.js";import{b as ue,g as nt,P as ot}from"../chunks/C_VuHRZi.js";import{g as Je}from"../chunks/I3fRAHRE.js";import{b as ke}from"../chunks/6wL3GoW6.js";import{p as st}from"../chunks/CdEA5IGF.js";const lt=`
	*,
	member_list_members (
		id,
		list_id,
		member_id,
		added_by,
		created_at,
		members (
			id,
			first_name,
			last_name,
			date_of_birth,
			phone_number
		)
	)
`;async function dt(){const{data:g,error:v}=await ue.from("member_lists").select(lt).order("name");if(v)throw v;return g||[]}async function ct(g){const{data:v,error:b}=await ue.from("member_lists").insert({name:g}).select().single();if(b)throw b;return v}async function mt(g,v){const{data:b,error:w}=await ue.from("member_lists").update({name:v,updated_at:new Date().toISOString()}).eq("id",g).select().single();if(w)throw w;return b}async function ut(g){const{error:v}=await ue.from("member_lists").delete().eq("id",g);if(v)throw v}async function Ze(g,v){const{data:b,error:w}=await ue.from("member_list_members").insert({list_id:g,member_id:v}).select("id, list_id, member_id, added_by, created_at").single();if(w)throw w;return b}async function ft(g,v){const{error:b}=await ue.from("member_list_members").delete().eq("list_id",g).eq("member_id",v);if(b)throw b}let Ne=null;const vt=()=>{const g=We(!1),v=We([]),b=We(null),w=async()=>{g.set(!1);const n=await dt();v.set(n);const L=Qe(b);!L&&n.length?b.set(n[0].id??null):L&&(n.some(q=>q.id===L)||b.set(n.length?n[0].id??null:null)),g.set(!0)};return Ne={stores:{ready:g,lists:v,selectedListId:b},actions:{reload:w,selectList:n=>{b.set(n)},createListWithMembers:async(n,L)=>{const z=await ct(n);if(z.id)for(const q of L)await Ze(z.id,q);return await w(),Qe(v).find(q=>q.id===z.id)??null},renameList:async(n,L)=>{await mt(n,L),await w()},removeList:async n=>{await ut(n),await w()},addMember:async(n,L)=>{await Ze(n,L),await w()},removeMember:async(n,L)=>{await ft(n,L),await w()}}},Ne},Ke=()=>Ne||vt();var bt=_('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-primary" type="button">Add</button></li>'),pt=_('<ul class="list-group list-group-flush border rounded mt-2"></ul>'),_t=_('<p class="text-muted mt-2">No members match that search.</p>'),gt=_('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-link text-danger text-decoration-none" type="button">Remove</button></li>'),ht=_('<div class="mt-3"><p class="mb-2">Selected members:</p> <ul class="list-group list-group-flush border rounded"></ul></div>'),yt=_("<!> Creating...",1),wt=_('<form class="d-flex flex-column gap-3"><div><label class="form-label" for="member-list-name">List name</label> <input id="member-list-name" class="form-control" type="text" required placeholder="e.g., Temple Preparation"/></div> <div><label class="form-label" for="member-list-members">Members (optional)</label> <input id="member-list-members" class="form-control" type="text" placeholder="Search members..."/> <!> <!></div> <div class="d-flex justify-content-end gap-2"><button class="btn btn-secondary" type="button" data-bs-dismiss="offcanvas">Cancel</button> <button class="btn btn-primary" type="submit"><!></button></div></form>');function Lt(g,v){Ue(v,!1);const b=()=>oe(z,"$members",w),[w,Z]=Ge(),R=y(),H=y();let S=y(!1),E=y(""),a=y([]),n=y("");const L=et(),{stores:{members:z}}=Je(),{actions:{createListWithMembers:q}}=Ke();function fe(s,c=[],t=6){if(!s.trim())return[];const p=s.toLowerCase();return e(R).filter(m=>{if(!m.id||c.includes(m.id))return!1;const x=m.first_name?.toLowerCase()??"",$=m.last_name?.toLowerCase()??"";return`${x} ${$}`.includes(p)}).slice(0,t)}function ve(s){!s.id||e(a).some(t=>t.id===s.id)||(l(a,[...e(a),s]),l(n,""))}function be(s){l(a,e(a).filter(c=>c.id!==s))}async function pe(s){if(s.preventDefault(),!e(E).trim())return;l(S,!0);const c=e(a).map(t=>t.id||0).filter(t=>!!t);try{await q(e(E).trim(),c),l(E,""),l(a,[]),l(n,""),L("listCreated")}catch(t){console.error("Failed to create list",t)}finally{l(S,!1)}}P(()=>b(),()=>{l(R,b()||[])}),P(()=>(e(n),e(a)),()=>{l(H,fe(e(n),e(a).map(s=>s.id||0).filter(s=>!!s)))}),He(),Ye();var Y=wt(),G=o(Y),J=f(o(G),2);Ee(J),i(G);var I=f(G,2),C=f(o(I),2);Ee(C);var F=f(C,2);{var O=s=>{var c=pt();xe(c,5,()=>e(H),$e,(t,p)=>{var m=bt(),x=o(m),$=o(x);i(x);var W=f(x,2);i(m),Q(()=>me($,`${e(p),M(()=>e(p).first_name)??""} ${e(p),M(()=>e(p).last_name)??""}`)),K("click",W,()=>ve(e(p))),d(t,m)}),i(c),d(s,c)},ee=s=>{var c=Me(),t=X(c);{var p=m=>{var x=_t();d(m,x)};D(t,m=>{e(n),M(()=>e(n).trim())&&m(p)},!0)}d(s,c)};D(F,s=>{e(H),M(()=>e(H).length)?s(O):s(ee,!1)})}var _e=f(F,2);{var ge=s=>{var c=ht(),t=f(o(c),2);xe(t,5,()=>e(a),$e,(p,m)=>{var x=gt(),$=o(x),W=o($);i($);var T=f($,2);i(x),Q(()=>me(W,`${e(m),M(()=>e(m).first_name)??""} ${e(m),M(()=>e(m).last_name)??""}`)),K("click",T,()=>{e(m)?.id&&be(e(m)?.id)}),d(p,x)}),i(t),i(c),d(s,c)};D(_e,s=>{e(a),M(()=>e(a).length)&&s(ge)})}i(I);var te=f(I,2),se=f(o(te),2),he=o(se);{var le=s=>{var c=yt(),t=X(c);Le(t,{size:"sm"}),tt(),d(s,c)},h=s=>{var c=De("Create List");d(s,c)};D(he,s=>{e(S)?s(le):s(h,!1)})}i(se),i(te),i(Y),Q(()=>se.disabled=e(S)),ke(J,()=>e(E),s=>l(E,s)),ke(C,()=>e(n),s=>l(n,s)),K("submit",Y,st(pe)),d(g,Y),Ve(),Z()}var xt=_("<!> Deleting...",1),$t=_('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-primary" type="button">Add</button></li>'),Mt=_('<ul class="list-group list-group-flush border rounded mt-2"></ul>'),St=_('<p class="text-muted mt-2">No members match that search.</p>'),It=_('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-link text-danger text-decoration-none" type="button" aria-label="Remove member"><i class="bi bi-trash"></i></button></li>'),Ct=_('<ul class="list-group"></ul>'),Dt=_('<p class="text-muted">No members in this list yet.</p>'),Et=_('<div class="d-flex flex-column gap-4"><div class="d-flex flex-column gap-4"><form class="d-flex flex-column gap-2"><input class="form-control" type="text" placeholder="List name"/> <div class="d-flex justify-content-between gap-2"><button class="btn btn-danger" aria-label="Delete list" type="button"><!></button> <div class="d-flex gap-2"><button class="btn btn-secondary" aria-label="Cancel" type="button" data-bs-dismiss="offcanvas"><!></button> <button class="btn btn-primary" aria-label="save" type="submit"><!></button></div></div></form></div> <div><h2 class="h6 mb-2">Add Member</h2> <input class="form-control" type="text" placeholder="Search members..."/> <!></div> <div><div class="d-flex align-items-center justify-content-between gap-2 mb-2"><h2 class="h6 mb-0">Members</h2></div> <!></div></div>'),kt=_('<p class="text-muted">Select a list to manage it.</p>');function Nt(g,v){Ue(v,!1);const b=()=>oe(fe,"$lists",R),w=()=>oe(ve,"$selectedListId",R),Z=()=>oe(q,"$members",R),[R,H]=Ge(),S=y(),E=y(),a=y(),n=y(),L=y(),z=y(),{stores:{members:q}}=Je(),{stores:{lists:fe,selectedListId:ve},actions:{addMember:be,removeMember:pe,renameList:Y,removeList:G}}=Ke(),J=et();let I=y(""),C=y(""),F=y(!1),O=y(!1),ee=y(null);function _e(t,p=[],m=6){if(!t.trim())return[];const x=t.toLowerCase();return e(L).filter($=>{if(!$.id||p.includes($.id))return!1;const W=$.first_name?.toLowerCase()??"",T=$.last_name?.toLowerCase()??"";return`${W} ${T}`.includes(x)}).slice(0,m)}async function ge(t){e(a)&&(await be(e(a).id,t),l(I,""))}async function te(t){e(a)&&await pe(e(a).id,t)}async function se(t){if(t.preventDefault(),!(!e(a)||!e(C).trim())){l(F,!0);try{await Y(e(a).id,e(C).trim())}catch(p){console.error("Failed to rename list",p)}finally{l(F,!1),J("listRenamed")}}}async function he(){if(e(a)&&confirm("Are you sure you want to delete this member list?")){l(O,!0);try{await G(e(a).id)}catch(t){console.error("Failed to delete list",t)}finally{l(O,!1),J("listDeleted")}}}P(()=>b(),()=>{l(S,b()||[])}),P(()=>w(),()=>{l(E,w())}),P(()=>(e(S),e(E)),()=>{l(a,e(S).find(t=>t.id===e(E))||null)}),P(()=>e(a),()=>{l(z,e(a)?.member_list_members?.map(t=>t.member_id)??[])}),P(()=>(e(a),e(I),e(z)),()=>{l(n,e(a)?_e(e(I),e(z)):[])}),P(()=>Z(),()=>{l(L,Z()||[])}),P(()=>(e(a),e(ee)),()=>{(e(a)?.id??null)!==e(ee)&&(l(ee,e(a)?.id??null),l(C,e(a)?.name??""))}),He(),Ye();var le=Me(),h=X(le);{var s=t=>{var p=Et(),m=o(p),x=o(m),$=o(x);Ee($);var W=f($,2),T=o(W),Pe=o(T);{var Se=r=>{var u=xt(),A=X(u);Le(A,{size:"sm"}),tt(),d(r,u)},je=r=>{var u=De("Delete List");d(r,u)};D(Pe,r=>{e(O)?r(Se):r(je,!1)})}i(T);var j=f(T,2),k=o(j),de=o(k);{var ze=r=>{Le(r,{size:"sm"})},Ae=r=>{var u=De("Cancel");d(r,u)};D(de,r=>{e(F)?r(ze):r(Ae,!1)})}i(k);var U=f(k,2),ae=o(U);{var Re=r=>{Le(r,{size:"sm"})},re=r=>{var u=De("Save");d(r,u)};D(ae,r=>{e(F)?r(Re):r(re,!1)})}i(U),i(j),i(W),i(x),i(m);var ie=f(m,2),ne=f(o(ie),2);Ee(ne);var qe=f(ne,2);{var Ie=r=>{var u=Mt();xe(u,5,()=>e(n),$e,(A,N)=>{var B=$t(),V=o(B),Be=o(V);i(V);var Oe=f(V,2);i(B),Q(()=>me(Be,`${e(N),M(()=>e(N).first_name)??""} ${e(N),M(()=>e(N).last_name)??""}`)),K("click",Oe,()=>{e(N)?.id&&ge(e(N)?.id)}),d(A,B)}),i(u),d(r,u)},ye=r=>{var u=Me(),A=X(u);{var N=B=>{var V=St();d(B,V)};D(A,B=>{e(I),M(()=>e(I).trim())&&B(N)},!0)}d(r,u)};D(qe,r=>{e(n),M(()=>e(n).length)?r(Ie):r(ye,!1)})}i(ie);var Ce=f(ie,2),ce=f(o(Ce),2);{var Fe=r=>{var u=Ct();xe(u,5,()=>(e(a),M(()=>e(a).member_list_members)),$e,(A,N)=>{var B=It(),V=o(B),Be=o(V);i(V);var Oe=f(V,2);i(B),Q(()=>me(Be,`${e(N),M(()=>e(N).members?.first_name)??""} ${e(N),M(()=>e(N).members?.last_name)??""}`)),K("click",Oe,()=>te(e(N).member_id)),d(A,B)}),i(u),d(r,u)},Te=r=>{var u=Dt();d(r,u)};D(ce,r=>{e(a),M(()=>e(a).member_list_members?.length)?r(Fe):r(Te,!1)})}i(Ce),i(p),Q(()=>{T.disabled=e(O),k.disabled=e(F),U.disabled=e(F)}),ke($,()=>e(C),r=>l(C,r)),K("click",T,he),K("submit",x,st(se)),ke(ne,()=>e(I),r=>l(I,r)),d(t,p)},c=t=>{var p=kt();d(t,p)};D(h,t=>{e(a)?t(s):t(c,!1)})}d(g,le),Ve(),H()}var Pt=_('<div class="alert alert-warning mt-4">You do not have permission to manage member lists.</div>'),jt=_('<a class="btn btn-sm btn-primary d-flex align-items-center gap-1" target="_blank" rel="noopener noreferrer" aria-label="Send text message to members"><i class="bi bi-chat-dots"></i></a>'),zt=_('<button class="btn btn-sm btn-outline-primary" type="button" disabled title="Add members with phone numbers to enable texting"><i class="bi bi-chat-dots"></i></button>'),At=_('<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><div> </div> <div class="d-flex align-items-center gap-2" aria-label="List actions" role="group"><span class="badge bg-secondary rounded-pill"> </span> <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="offcanvas" aria-label="Edit list"><i class="bi bi-pencil"></i></button> <!></div></div>'),Rt=_('<div class="list-group list-group-flush"></div>'),qt=_('<p class="text-muted p-3 mb-0">No lists yet. Create one to get started.</p>'),Ft=_('<div class="p-4"><!></div>'),Tt=_('<div class="card"><div class="card-header"><div class="d-flex justify-content-between align-items-center w-100"><span>Lists</span> <div class="d-flex align-items-center gap-2"><button class="btn btn-primary btn-sm" aria-label="Create new list" type="button" data-bs-toggle="offcanvas"><i class="bi bi-plus"></i></button></div></div></div> <div class="card-body p-0"><!></div></div> <!> <!>',1);function Bt(g,v){Ue(v,!1);const b=()=>oe(ve,"$lists",R),w=()=>oe(be,"$selectedListId",R),Z=()=>oe(fe,"$ready",R),[R,H]=Ge(),S=y(),E=y(),a=y(),n=y(),L=y(),{stores:{currentUserHasPermission:z}}=nt(),{actions:{reload:q}}=Je(),{stores:{ready:fe,lists:ve,selectedListId:be},actions:{reload:pe,selectList:Y}}=Ke();let G=y(!1),J=!1;rt(()=>{const h=z.subscribe(s=>{const c=s(ot.ManageMemberLists);c&&!J&&(J=!0,q().catch(t=>console.error("Members reload failed",t)),pe().catch(t=>console.error("Member lists reload failed",t))),l(G,c)});return()=>{h()}});const I="member-lists-create-drawer",C="member-lists-edit-drawer";function F(h){return h?h.replace(/[^\d+]/g,""):""}function O(h){if(typeof window>"u")return;const s=document.getElementById(h);if(!s)return;window.bootstrap?.Offcanvas?.getInstance(s)?.hide()}function ee(){O(C)}function _e(){O(C)}function ge(){O(I)}P(()=>b(),()=>{l(S,b()||[])}),P(()=>w(),()=>{l(E,w())}),P(()=>(e(S),e(E)),()=>{l(a,e(S).find(h=>h.id===e(E))||null)}),P(()=>e(a),()=>{l(n,e(a)?.member_list_members?.map(h=>F(h.members?.phone_number)).filter(h=>h.length>0)??[])}),P(()=>e(n),()=>{l(L,e(n).length?`sms:${e(n).join(";")}`:"")}),He(),Ye();var te=Me(),se=X(te);{var he=h=>{var s=Pt();d(h,s)},le=h=>{var s=Tt(),c=X(s),t=o(c),p=o(t),m=f(o(p),2),x=o(m);we(x,"data-bs-target",`#${I}`),we(x,"aria-controls",I),i(m),i(p),i(t);var $=f(t,2),W=o($);{var T=j=>{var k=Me(),de=X(k);{var ze=U=>{var ae=Rt();xe(ae,5,()=>e(S),$e,(Re,re)=>{var ie=At(),ne=o(ie),qe=o(ne,!0);i(ne);var Ie=f(ne,2),ye=o(Ie),Ce=o(ye,!0);i(ye);var ce=f(ye,2);we(ce,"data-bs-target",`#${C}`),we(ce,"aria-controls",C);var Fe=f(ce,2);{var Te=u=>{var A=jt();Q(()=>we(A,"href",e(L))),d(u,A)},r=u=>{var A=zt();d(u,A)};D(Fe,u=>{e(L)?u(Te):u(r,!1)})}i(Ie),i(ie),Q(()=>{me(qe,(e(re),M(()=>e(re).name))),me(Ce,(e(re),M(()=>e(re).member_list_members?.length??0)))}),K("click",ce,()=>Y(e(re).id??null)),d(Re,ie)}),i(ae),d(U,ae)},Ae=U=>{var ae=qt();d(U,ae)};D(de,U=>{e(S),M(()=>e(S).length)?U(ze):U(Ae,!1)})}d(j,k)},Pe=j=>{var k=Ft(),de=o(k);Le(de,{}),i(k),d(j,k)};D(W,j=>{Z()?j(T):j(Pe,!1)})}i($),i(c);var Se=f(c,2);Xe(Se,{title:"Create Member List",id:I,children:(j,k)=>{Lt(j,{$$events:{listCreated:ge}})},$$slots:{default:!0}});var je=f(Se,2);{let j=it(()=>(e(a),M(()=>e(a)?`Edit ${e(a).name}`:"Edit Member List")));Xe(je,{get title(){return e(j)},id:C,children:(k,de)=>{Nt(k,{$$events:{listDeleted:ee,listRenamed:_e}})},$$slots:{default:!0}})}d(h,s)};D(se,h=>{e(G)?h(le,!1):h(he)})}d(g,te),Ve(),H()}function is(g){at(g,{pageTitle:"Member Lists",children:(v,b)=>{Bt(v,{})},$$slots:{default:!0}})}export{is as component};
