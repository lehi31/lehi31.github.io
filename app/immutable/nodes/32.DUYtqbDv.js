import"../chunks/NZTpNUN0.js";import"../chunks/69_IOA4Y.js";import{P as dt}from"../chunks/BWH6IW0v.js";import{w as Te,g as Ge,c as Qe,o as mt}from"../chunks/DjNGvcU6.js";import{p as qe,aj as N,D as l,E as h,g as e,ak as Be,c as o,s as u,r as i,u as w,t as re,a as Oe,f as ne,F as Xe,R as ut}from"../chunks/JKZwkikK.js";import{b as me,i as D,e as ie,a as We,s as be}from"../chunks/BxjzTaz1.js";import{e as xe,i as $e}from"../chunks/B2BlSr7K.js";import{f as b,a as c,c as Me,t as Ce}from"../chunks/JDsN5plM.js";import{r as Ie,s as we}from"../chunks/BgG85uRf.js";import{b as pe,g as ft,P as vt,c as bt}from"../chunks/BCnZ3Wiu.js";import{i as He}from"../chunks/b8c_lO2i.js";import{D as Je}from"../chunks/BBrfMQ59.js";import{S as Le}from"../chunks/Cu8yd2D0.js";import{g as Ue}from"../chunks/Me7xeZpf.js";import{b as De}from"../chunks/BL6gm64P.js";import{p as Ze}from"../chunks/CdEA5IGF.js";const pt=`
	*,
	member_list_members (
		id,
		list_id,
		member_id,
		added_by,
		created_at,
		members (
			id,
			first_name,
			last_name,
			date_of_birth,
			phone_number
		)
	)
`;async function _t(){const{data:p,error:f}=await pe.from("member_lists").select(pt).order("name");if(f)throw f;return p||[]}async function gt(p){const{data:f,error:v}=await pe.from("member_lists").insert({name:p}).select().single();if(v)throw v;return f}async function ht(p,f){const{data:v,error:y}=await pe.from("member_lists").update({name:f,updated_at:new Date().toISOString()}).eq("id",p).select().single();if(y)throw y;return v}async function yt(p){const{error:f}=await pe.from("member_lists").delete().eq("id",p);if(f)throw f}async function Ke(p,f){const{data:v,error:y}=await pe.from("member_list_members").insert({list_id:p,member_id:f}).select("id, list_id, member_id, added_by, created_at").single();if(y)throw y;return v}async function wt(p,f){const{error:v}=await pe.from("member_list_members").delete().eq("list_id",p).eq("member_id",f);if(v)throw v}let ke=null;const Lt=()=>{const p=Te(!1),f=Te([]),v=Te(null),y=async()=>{p.set(!1);const n=await _t();f.set(n);const $=Ge(v);!$&&n.length?v.set(n[0].id??null):$&&(n.some(k=>k.id===$)||v.set(n.length?n[0].id??null:null)),p.set(!0)};return ke={stores:{ready:p,lists:f,selectedListId:v},actions:{reload:y,selectList:n=>{v.set(n)},createListWithMembers:async(n,$)=>{const R=await gt(n);if(R.id)for(const k of $)await Ke(R.id,k);return await y(),Ge(f).find(k=>k.id===R.id)??null},renameList:async(n,$)=>{await ht(n,$),await y()},removeList:async n=>{await yt(n),await y()},addMember:async(n,$)=>{await Ke(n,$),await y()},removeMember:async(n,$)=>{await wt(n,$),await y()}}},ke},Ve=()=>ke||Lt();var xt=b('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-primary" type="button">Add</button></li>'),$t=b('<ul class="list-group list-group-flush border rounded mt-2"></ul>'),Mt=b('<p class="text-muted mt-2">No members match that search.</p>'),St=b('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-link text-danger text-decoration-none" type="button">Remove</button></li>'),Ct=b('<div class="mt-3"><p class="mb-2">Selected members:</p> <ul class="list-group list-group-flush border rounded"></ul></div>'),It=b("<!> Creating...",1),Dt=b('<form class="d-flex flex-column gap-3"><div><label class="form-label" for="member-list-name">List name</label> <input id="member-list-name" class="form-control" type="text" required placeholder="e.g., Temple Preparation"/></div> <div><label class="form-label" for="member-list-members">Members (optional)</label> <input id="member-list-members" class="form-control" type="text" placeholder="Search members..."/> <!> <!></div> <div class="d-flex justify-content-end gap-2"><button class="btn btn-secondary" type="button" data-bs-dismiss="offcanvas">Cancel</button> <button class="btn btn-primary" type="submit"><!></button></div></form>');function kt(p,f){qe(f,!1);const v=()=>me(R,"$members",y),[y,oe]=We(),q=h(),V=h();let S=h(!1),C=h(""),s=h([]),n=h("");const $=Qe(),{stores:{members:R}}=Ue(),{actions:{createListWithMembers:k}}=Ve();function le(r,d=[],_=6){if(!r.trim())return[];const I=r.toLowerCase();return e(q).filter(g=>{if(!g.id||d.includes(g.id))return!1;const a=g.first_name?.toLowerCase()??"",L=g.last_name?.toLowerCase()??"";return`${a} ${L}`.includes(I)}).slice(0,_)}function _e(r){!r.id||e(s).some(_=>_.id===r.id)||(l(s,[...e(s),r]),l(n,""))}function ge(r){l(s,e(s).filter(d=>d.id!==r))}async function ue(r){if(r.preventDefault(),!e(C).trim())return;l(S,!0);const d=e(s).map(_=>_.id||0).filter(_=>!!_);try{await k(e(C).trim(),d),l(C,""),l(s,[]),l(n,""),$("listCreated")}catch(_){console.error("Failed to create list",_)}finally{l(S,!1)}}N(()=>v(),()=>{l(q,v()||[])}),N(()=>(e(n),e(s)),()=>{l(V,le(e(n),e(s).map(r=>r.id||0).filter(r=>!!r)))}),Be(),He();var Y=Dt(),H=o(Y),U=u(o(H),2);Ie(U),i(H);var G=u(H,2),ee=u(o(G),2);Ie(ee);var z=u(ee,2);{var J=r=>{var d=$t();xe(d,5,()=>e(V),$e,(_,I)=>{var g=xt(),a=o(g),L=o(a);i(a);var F=u(a,2);i(g),re(()=>be(L,`${e(I),w(()=>e(I).first_name)??""} ${e(I),w(()=>e(I).last_name)??""}`)),ie("click",F,()=>_e(e(I))),c(_,g)}),i(d),c(r,d)},B=r=>{var d=Me(),_=ne(d);{var I=g=>{var a=Mt();c(g,a)};D(_,g=>{e(n),w(()=>e(n).trim())&&g(I)},!0)}c(r,d)};D(z,r=>{e(V),w(()=>e(V).length)?r(J):r(B,!1)})}var te=u(z,2);{var ce=r=>{var d=Ct(),_=u(o(d),2);xe(_,5,()=>e(s),$e,(I,g)=>{var a=St(),L=o(a),F=o(L);i(L);var K=u(L,2);i(a),re(()=>be(F,`${e(g),w(()=>e(g).first_name)??""} ${e(g),w(()=>e(g).last_name)??""}`)),ie("click",K,()=>{e(g)?.id&&ge(e(g)?.id)}),c(I,a)}),i(_),i(d),c(r,d)};D(te,r=>{e(s),w(()=>e(s).length)&&r(ce)})}i(G);var fe=u(G,2),M=u(o(fe),2),P=o(M);{var O=r=>{var d=It(),_=ne(d);Le(_,{size:"sm"}),Xe(),c(r,d)},A=r=>{var d=Ce("Create List");c(r,d)};D(P,r=>{e(S)?r(O):r(A,!1)})}i(M),i(fe),i(Y),re(()=>M.disabled=e(S)),De(U,()=>e(C),r=>l(C,r)),De(ee,()=>e(n),r=>l(n,r)),ie("submit",Y,Ze(ue)),c(p,Y),Oe(),oe()}var Et=b("<!> Deleting...",1),jt=b('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-primary" type="button">Add</button></li>'),Nt=b('<ul class="list-group list-group-flush border rounded mt-2"></ul>'),Pt=b('<p class="text-muted mt-2">No members match that search.</p>'),Rt=b('<a class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1" target="_blank" rel="noopener noreferrer"><i class="bi bi-chat-dots"></i> <span>Text List</span></a>'),zt=b('<button class="btn btn-sm btn-outline-primary" type="button" disabled title="Add members with phone numbers to enable texting">Text List</button>'),At=b('<li class="list-group-item d-flex justify-content-between align-items-center"><span> </span> <button class="btn btn-sm btn-link text-danger text-decoration-none" type="button" aria-label="Remove member"><i class="bi bi-trash"></i></button></li>'),Ft=b('<ul class="list-group"></ul>'),Tt=b('<p class="text-muted">No members in this list yet.</p>'),qt=b('<div class="d-flex flex-column gap-4"><div class="d-flex flex-column gap-4"><form class="d-flex flex-column gap-2"><input class="form-control" type="text" placeholder="List name"/> <div class="d-flex justify-content-between gap-2"><button class="btn btn-danger" aria-label="Delete list" type="button"><!></button> <div class="d-flex gap-2"><button class="btn btn-secondary" aria-label="Cancel" type="button" data-bs-dismiss="offcanvas"><!></button> <button class="btn btn-primary" aria-label="save" type="submit"><!></button></div></div></form></div> <div><h2 class="h6 mb-2">Add Member</h2> <input class="form-control" type="text" placeholder="Search members..."/> <!></div> <div><div class="d-flex align-items-center justify-content-between gap-2 mb-2"><h2 class="h6 mb-0">Members</h2> <!></div> <!></div></div>'),Bt=b('<p class="text-muted">Select a list to manage it.</p>');function Ot(p,f){qe(f,!1);const v=()=>me(ge,"$lists",q),y=()=>me(ue,"$selectedListId",q),oe=()=>me(_e,"$members",q),[q,V]=We(),S=h(),C=h(),s=h(),n=h(),$=h(),R=h(),k=h(),le=h(),{stores:{members:_e}}=Ue(),{stores:{lists:ge,selectedListId:ue},actions:{addMember:Y,removeMember:H,renameList:U,removeList:G}}=Ve(),ee=Qe();let z=h(""),J=h(""),B=h(!1),te=h(!1),ce=h(null);function fe(a,L=[],F=6){if(!a.trim())return[];const K=a.toLowerCase();return e($).filter(x=>{if(!x.id||L.includes(x.id))return!1;const E=x.first_name?.toLowerCase()??"",T=x.last_name?.toLowerCase()??"";return`${E} ${T}`.includes(K)}).slice(0,F)}async function M(a){e(s)&&(await Y(e(s).id,a),l(z,""))}function P(a){return a?a.replace(/[^\d+]/g,""):""}async function O(a){e(s)&&await H(e(s).id,a)}async function A(a){if(a.preventDefault(),!(!e(s)||!e(J).trim())){l(B,!0);try{await U(e(s).id,e(J).trim())}catch(L){console.error("Failed to rename list",L)}finally{l(B,!1),ee("listRenamed")}}}async function r(){if(e(s)&&confirm("Are you sure you want to delete this member list?")){l(te,!0);try{await G(e(s).id)}catch(a){console.error("Failed to delete list",a)}finally{l(te,!1),ee("listDeleted")}}}N(()=>v(),()=>{l(S,v()||[])}),N(()=>y(),()=>{l(C,y())}),N(()=>(e(S),e(C)),()=>{l(s,e(S).find(a=>a.id===e(C))||null)}),N(()=>e(s),()=>{l(R,e(s)?.member_list_members?.map(a=>a.member_id)??[])}),N(()=>(e(s),e(z),e(R)),()=>{l(n,e(s)?fe(e(z),e(R)):[])}),N(()=>oe(),()=>{l($,oe()||[])}),N(()=>e(s),()=>{l(k,e(s)?.member_list_members?.map(a=>P(a.members?.phone_number)).filter(a=>a.length>0)??[])}),N(()=>e(k),()=>{l(le,e(k).length?`sms:${e(k).join(";")}`:"")}),N(()=>(e(s),e(ce)),()=>{(e(s)?.id??null)!==e(ce)&&(l(ce,e(s)?.id??null),l(J,e(s)?.name??""))}),Be(),He();var d=Me(),_=ne(d);{var I=a=>{var L=qt(),F=o(L),K=o(F),x=o(K);Ie(x);var E=u(x,2),T=o(E),Ee=o(T);{var je=t=>{var m=Et(),de=ne(m);Le(de,{size:"sm"}),Xe(),c(t,m)},se=t=>{var m=Ce("Delete List");c(t,m)};D(Ee,t=>{e(te)?t(je):t(se,!1)})}i(T);var ae=u(T,2),ve=o(ae),Q=o(ve);{var X=t=>{Le(t,{size:"sm"})},he=t=>{var m=Ce("Cancel");c(t,m)};D(Q,t=>{e(B)?t(X):t(he,!1)})}i(ve);var ye=u(ve,2),Se=o(ye);{var Ne=t=>{Le(t,{size:"sm"})},et=t=>{var m=Ce("Save");c(t,m)};D(Se,t=>{e(B)?t(Ne):t(et,!1)})}i(ye),i(ae),i(E),i(K),i(F);var Pe=u(F,2),Re=u(o(Pe),2);Ie(Re);var tt=u(Re,2);{var st=t=>{var m=Nt();xe(m,5,()=>e(n),$e,(de,j)=>{var W=jt(),Z=o(W),Ae=o(Z);i(Z);var Fe=u(Z,2);i(W),re(()=>be(Ae,`${e(j),w(()=>e(j).first_name)??""} ${e(j),w(()=>e(j).last_name)??""}`)),ie("click",Fe,()=>{e(j)?.id&&M(e(j)?.id)}),c(de,W)}),i(m),c(t,m)},at=t=>{var m=Me(),de=ne(m);{var j=W=>{var Z=Pt();c(W,Z)};D(de,W=>{e(z),w(()=>e(z).trim())&&W(j)},!0)}c(t,m)};D(tt,t=>{e(n),w(()=>e(n).length)?t(st):t(at,!1)})}i(Pe);var Ye=u(Pe,2),ze=o(Ye),rt=u(o(ze),2);{var it=t=>{var m=Rt();re(()=>we(m,"href",e(le))),c(t,m)},nt=t=>{var m=zt();c(t,m)};D(rt,t=>{e(le)?t(it):t(nt,!1)})}i(ze);var ot=u(ze,2);{var lt=t=>{var m=Ft();xe(m,5,()=>(e(s),w(()=>e(s).member_list_members)),$e,(de,j)=>{var W=At(),Z=o(W),Ae=o(Z);i(Z);var Fe=u(Z,2);i(W),re(()=>be(Ae,`${e(j),w(()=>e(j).members?.first_name)??""} ${e(j),w(()=>e(j).members?.last_name)??""}`)),ie("click",Fe,()=>O(e(j).member_id)),c(de,W)}),i(m),c(t,m)},ct=t=>{var m=Tt();c(t,m)};D(ot,t=>{e(s),w(()=>e(s).member_list_members?.length)?t(lt):t(ct,!1)})}i(Ye),i(L),re(()=>{T.disabled=e(te),ve.disabled=e(B),ye.disabled=e(B)}),De(x,()=>e(J),t=>l(J,t)),ie("click",T,r),ie("submit",K,Ze(A)),De(Re,()=>e(z),t=>l(z,t)),c(a,L)},g=a=>{var L=Bt();c(a,L)};D(_,a=>{e(s)?a(I):a(g,!1)})}c(p,d),Oe(),V()}var Wt=b('<div class="alert alert-warning mt-4">You do not have permission to manage member lists.</div>'),Ht=b('<button type="button" data-bs-toggle="offcanvas"><span> </span> <span class="badge bg-secondary rounded-pill"> </span></button>'),Ut=b('<div class="list-group list-group-flush"></div>'),Vt=b('<p class="text-muted p-3 mb-0">No lists yet. Create one to get started.</p>'),Yt=b('<div class="p-4"><!></div>'),Gt=b('<div class="card"><div class="card-header"><div class="d-flex justify-content-between align-items-center w-100"><span>Lists</span> <div class="d-flex align-items-center gap-2"><button class="btn btn-primary btn-sm" aria-label="Create new list" type="button" data-bs-toggle="offcanvas"><i class="bi bi-plus"></i></button></div></div></div> <div class="card-body p-0"><!></div></div> <!> <!>',1);function Jt(p,f){qe(f,!1);const v=()=>me(k,"$lists",q),y=()=>me(le,"$selectedListId",q),oe=()=>me(R,"$ready",q),[q,V]=We(),S=h(),C=h(),s=h(),{stores:{currentUserHasPermission:n}}=ft(),{actions:{reload:$}}=Ue(),{stores:{ready:R,lists:k,selectedListId:le},actions:{reload:_e,selectList:ge}}=Ve();let ue=h(!1),Y=!1;mt(()=>{const M=n.subscribe(P=>{const O=P(vt.ManageMemberLists);O&&!Y&&(Y=!0,$().catch(A=>console.error("Members reload failed",A)),_e().catch(A=>console.error("Member lists reload failed",A))),l(ue,O)});return()=>{M()}});const H="member-lists-create-drawer",U="member-lists-edit-drawer";function G(M){if(typeof window>"u")return;const P=document.getElementById(M);if(!P)return;window.bootstrap?.Offcanvas?.getInstance(P)?.hide()}function ee(){G(U)}function z(){G(U)}function J(){G(H)}N(()=>v(),()=>{l(S,v()||[])}),N(()=>y(),()=>{l(C,y())}),N(()=>(e(S),e(C)),()=>{l(s,e(S).find(M=>M.id===e(C))||null)}),Be(),He();var B=Me(),te=ne(B);{var ce=M=>{var P=Wt();c(M,P)},fe=M=>{var P=Gt(),O=ne(P),A=o(O),r=o(A),d=u(o(r),2),_=o(d);we(_,"data-bs-target",`#${H}`),we(_,"aria-controls",H),i(d),i(r),i(A);var I=u(A,2),g=o(I);{var a=x=>{var E=Me(),T=ne(E);{var Ee=se=>{var ae=Ut();xe(ae,5,()=>e(S),$e,(ve,Q)=>{var X=Ht();we(X,"data-bs-target",`#${U}`),we(X,"aria-controls",U);var he=o(X),ye=o(he,!0);i(he);var Se=u(he,2),Ne=o(Se,!0);i(Se),i(X),re(()=>{bt(X,1,(e(Q),e(C),w(()=>`list-group-item list-group-item-action d-flex justify-content-between align-items-center ${e(Q).id===e(C)?"active":""}`))),be(ye,(e(Q),w(()=>e(Q).name))),be(Ne,(e(Q),w(()=>e(Q).member_list_members?.length??0)))}),ie("click",X,()=>ge(e(Q).id??null)),c(ve,X)}),i(ae),c(se,ae)},je=se=>{var ae=Vt();c(se,ae)};D(T,se=>{e(S),w(()=>e(S).length)?se(Ee):se(je,!1)})}c(x,E)},L=x=>{var E=Yt(),T=o(E);Le(T,{}),i(E),c(x,E)};D(g,x=>{oe()?x(a):x(L,!1)})}i(I),i(O);var F=u(O,2);Je(F,{title:"Create Member List",id:H,children:(x,E)=>{kt(x,{$$events:{listCreated:J}})},$$slots:{default:!0}});var K=u(F,2);{let x=ut(()=>(e(s),w(()=>e(s)?`Edit ${e(s).name}`:"Edit Member List")));Je(K,{get title(){return e(x)},id:U,children:(E,T)=>{Ot(E,{$$events:{listDeleted:ee,listRenamed:z}})},$$slots:{default:!0}})}c(M,P)};D(te,M=>{e(ue)?M(fe,!1):M(ce)})}c(p,B),Oe(),V()}function us(p){dt(p,{pageTitle:"Member Lists",children:(f,v)=>{Jt(f,{})},$$slots:{default:!0}})}export{us as component};
